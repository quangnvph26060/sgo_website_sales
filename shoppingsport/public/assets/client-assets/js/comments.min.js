function dataURLtoFile(e, t) {
    for (
        var a = e.split(","),
            n = a[0].match(/:(.*?);/)[1],
            o = atob(a[1]),
            i = o.length,
            m = new Uint8Array(i);
        i--;

    )
        m[i] = o.charCodeAt(i);
    return new File([m], t, { type: n });
}
function alertTextCmt(e) {
    alert_show("error", e);
}
function formatSizeCommentFile(e) {
    return (
        e >= 1073741824
            ? (e = (e / 1073741824).toFixed(2) + " GB")
            : e >= 1048576
            ? (e = (e / 1048576).toFixed(2) + " MB")
            : e >= 1024
            ? (e = (e / 1024).toFixed(2) + " KB")
            : e > 1
            ? (e += " bytes")
            : 1 == e
            ? (e += " byte")
            : (e = "0 bytes"),
        e
    );
}
function validateEmailCmt(e) {
    return /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(
        String(e).toLowerCase()
    );
}
function validatePhoneCmt(e) {
    var t = !1;
    return (
        "" !=
            (e = (e = (e = (e = (e = e.trim()).replace("(+84)", "0")).replace(
                "+84",
                "0"
            )).replace("0084", "0")).replace(/ /g, "")) &&
            (t = e.length >= 9 && e.length <= 11),
        t
    );
}
function commentLoad(e, t, a, n, o) {
    (data = { type: e, type_id: t, pageCmt: a }),
        $.ajax({
            headers: {
                "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
            },
            type: "POST",
            url: variable.ajax_load_url,
            data: data,
            beforeSend: function () {
                $(".comments-loading")
                    .css({ visibility: "visible", opacity: 0 })
                    .animate({ opacity: 1 }, 200);
            },
            success: function (e) {
                $(".comments-loading").animate(
                    { opacity: 0 },
                    200,
                    function () {
                        $(".comments-loading").css("visibility", "hidden");
                    }
                ),
                    n
                        .closest(".comments")
                        .find(".total-comment")
                        .text(e.comment_totals),
                    0 == e.has_more
                        ? n
                              .closest(".comments")
                              .find(".comments-loadmore")
                              .css("display", "none")
                        : n
                              .closest(".comments")
                              .find(".comments-loadmore")
                              .css("display", "block"),
                    1 == o
                        ? n
                              .closest(".comments")
                              .find(".comments-list")
                              .empty()
                              .append(e.html)
                        : n
                              .closest(".comments")
                              .find(".comments-list")
                              .append(e.html),
                    n
                        .closest(".comments")
                        .find("*[data-comments_loadmore]")
                        .data("page_cmt", a)
                        .attr("data-page_cmt", a),
                    n
                        .closest(".comments")
                        .find(".comments-info__filter")
                        .find("input[name=keyword]")
                        .val("");
            },
            error: function (e) {
                $(".comments-loading").animate(
                    { opacity: 0 },
                    200,
                    function () {
                        $(".comments-loading").css("visibility", "hidden");
                    }
                ),
                    alertTextCmt(variable.ajax_load_error_text);
            },
        });
}
function commendAdd(e, t, a, n) {
    $.ajax({
        headers: {
            "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
        },
        type: "POST",
        url: variable.ajax_add_url,
        data: n,
        enctype: "multipart/form-data",
        processData: !1,
        contentType: !1,
        beforeSend: function () {
            $(".comments-loading")
                .css({ visibility: "visible", opacity: 0 })
                .animate({ opacity: 1 }, 200);
        },
        success: function (n) {
            $(".comments-loading").animate({ opacity: 0 }, 200, function () {
                $(".comments-loading").css("visibility", "hidden");
            }),
                2 == n.status
                    ? alertTextCmt(n.message)
                    : (commentLoad(e, t, 1, a, !0),
                      a.closest(".comments").find("*[name=content]").val(""),
                      a.closest(".comments").find("*[name=name]").val(""),
                      a.closest(".comments").find("*[name=phone]").val(""),
                      a.closest(".comments").find("*[name=email]").val(""),
                      a.closest(".comments").find("*[name=parent_id]").val(""),
                      a
                          .closest(".comments")
                          .find("*[name=comment_file]")
                          .val(""),
                      a
                          .closest(".comments")
                          .find("*[data-page_cmt]")
                          .attr("data-page_cmt", 1)
                          .data("page_cmt", 1),
                      a
                          .closest(".comments")
                          .find(".comments-add__preview")
                          .empty(),
                      a
                          .closest(".comments")
                          .find(".moreinfo")
                          .removeClass("open"),
                      $("body").css("overflow", "auto"));
        },
        error: function (e) {
            $(".comments-loading").animate({ opacity: 0 }, 200, function () {
                $(".comments-loading").css("visibility", "hidden");
            }),
                alertTextCmt(variable.ajax_load_error_text);
        },
    });
}
function commentSearch(e, t, a, n, o, i) {
    (data = { type: e, type_id: t, keyword: a, pageCmt: n }),
        $.ajax({
            headers: {
                "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
            },
            type: "POST",
            url: variable.ajax_search_url,
            data: data,
            beforeSend: function () {
                $(".comments-loading")
                    .css({ visibility: "visible", opacity: 0 })
                    .animate({ opacity: 1 }, 200);
            },
            success: function (e) {
                $(".comments-loading").animate(
                    { opacity: 0 },
                    200,
                    function () {
                        $(".comments-loading").css("visibility", "hidden");
                    }
                ),
                    0 == e.has_more
                        ? o
                              .closest(".comments")
                              .find(".comments-loadmore")
                              .css("display", "none")
                        : o
                              .closest(".comments")
                              .find(".comments-loadmore")
                              .css("display", "block"),
                    1 == i
                        ? o
                              .closest(".comments")
                              .find(".comments-list")
                              .empty()
                              .append(e.html)
                        : o
                              .closest(".comments")
                              .find(".comments-list")
                              .append(e.html),
                    o
                        .closest(".comments")
                        .find("*[data-comments_loadmore]")
                        .data("page_cmt", n)
                        .attr("data-page_cmt", n);
            },
            error: function (e) {
                $(".comments-loading").animate(
                    { opacity: 0 },
                    200,
                    function () {
                        $(".comments-loading").css("visibility", "hidden");
                    }
                ),
                    alertTextCmt(variable.ajax_load_error_text);
            },
        });
}
$(document).ready(function () {
    (variable = $(".lang_comments").data("value")),
        (variable = atob(variable)),
        (variable = JSON.parse(variable)),
        $("body").on("click", ".comments .popup-image", function (e) {
            e.preventDefault(),
                e.stopImmediatePropagation(),
                (src = $(this).data("image")),
                $(this)
                    .closest(".comments")
                    .find(".previews")
                    .find(".comments-popup__body")
                    .find("img")
                    .attr("src", src),
                $(this).closest(".comments").find(".previews").addClass("open"),
                $("body").css("overflow", "hidden");
        }),
        $("body").on("change", "input[name=comment_file]", function (e) {
            e.preventDefault(),
                (file = this.files),
                (check_extention = 0),
                (allowed_size = variable.allowed_size),
                (allowed_extention = ["jpg", "jpeg", "png"]);
            let t = 0;
            $(this)
                .closest(".comments-add")
                .find(".comments-add__preview")
                .empty()
                .change(),
                $.each(file, function (e, a) {
                    if (
                        (a.size > allowed_size && (check_size = 1),
                        -1 ==
                            $.inArray(
                                a.name.split(".").pop().toLowerCase(),
                                allowed_extention
                            ))
                    )
                        check_extention = 1;
                    else {
                        image_preview = URL.createObjectURL(a);
                        let e = `<div class="image">\n                    <img src="${image_preview}">\n                    <input type="file" name="image[]" id="upload_${t}" style="display: none;">\n                </div>`;
                        $(".comments-add")
                            .find(".comments-add__preview")
                            .append(e);
                        let n = document.querySelector("input#upload_" + t),
                            o =
                                new ClipboardEvent("").clipboardData ||
                                new DataTransfer();
                        a.size > 512e3 || a.fileSize > 512e3
                            ? resizeImage(a, {
                                  use_reader: !1,
                                  mode: 2,
                                  val: 400,
                                  type: "image/jpeg",
                                  quality: 0.8,
                                  callback: function (e) {
                                      let t = dataURLtoFile(e, a.name);
                                      o.items.add(t), (n.files = o.files);
                                  },
                              })
                            : (o.items.add(a), (n.files = o.files)),
                            t++;
                    }
                }),
                1 == check_extention &&
                    alertTextCmt(
                        variable.valid_extention +
                            " " +
                            allowed_extention.join(", ")
                    );
        }),
        $("body").on(
            "click",
            ".comments *[data-comments_loadmore]",
            function (e) {
                e.preventDefault(),
                    e.stopImmediatePropagation(),
                    (type = $(this).closest(".comments").data("type")),
                    (type_id = $(this).closest(".comments").data("type_id")),
                    (pageCmt = parseInt($(this).data("page_cmt"))),
                    (pageCmt += 1),
                    "" ==
                    $(this)
                        .closest(".comments")
                        .find(".comments-info__filter")
                        .find("input[name=keyword]")
                        .val()
                        ? commentLoad(type, type_id, pageCmt, $(this))
                        : ((value = $(this)
                              .closest(".comments")
                              .find(".comments-info__filter")
                              .find("input[name=keyword]")
                              .val()),
                          commentSearch(
                              type,
                              type_id,
                              value,
                              pageCmt,
                              $(this),
                              !1
                          ));
            }
        ),
        (start = null),
        $("body").on(
            "click",
            ".comments-info__filter button[type=submit]",
            function (e) {
                e.preventDefault(),
                    e.stopImmediatePropagation(),
                    (e = $(this)),
                    clearTimeout(start),
                    (comments = e.closest(".comments")),
                    (type = comments.data("type")),
                    (type_id = comments.data("type_id")),
                    (value = e
                        .closest(".comments-info__filter")
                        .find("input[name=keyword]")
                        .val()),
                    commentSearch(type, type_id, value, 1, e, !0);
            }
        ),
        $("body").on(
            "keyup",
            ".comments-info__filter input[name=keyword]",
            function (e) {
                e.preventDefault(),
                    e.stopImmediatePropagation(),
                    (e = $(this)),
                    clearTimeout(start),
                    (value = e.val()),
                    (start = setTimeout(function () {
                        e.closest(".comments-info__filter")
                            .find("button[type=submit]")
                            .click();
                    }, 2e3));
            }
        ),
        $("body").on("click", ".comments *[data-reply]", function (e) {
            e.preventDefault(),
                e.stopImmediatePropagation(),
                (item = $(this).closest(".item[data-comment_id]")),
                (tags = $(this).data("reply")),
                $(".item-reply").find(".comments-add").css("display", "none"),
                $(".comments-add__moreinfo").css("display", "none"),
                item.find(".item-reply").find(".comments-add").slideDown(),
                item
                    .find(".item-reply")
                    .find(".comments-add")
                    .find(".comments-add__form-field")
                    .val(tags);
        }),
        (content = null),
        (file_data = null),
        (parent_id = null),
        $("body").on(
            "click",
            ".comments *[data-comments_moreinfo]",
            function (e) {
                e.preventDefault(),
                    e.stopImmediatePropagation(),
                    $(this)
                        .closest(".comments")
                        .find(".moreinfo")
                        .addClass("open"),
                    $("body").css("overflow", "hidden"),
                    (content = $(this)
                        .closest(".comments-add")
                        .find("*[name=content]")
                        .val()),
                    (parent_id = $(this).data("comment_id")),
                    1 == variable.upload_image &&
                        (file_data = $(this)
                            .closest(".comments-add")
                            .find("*[name=comment_file]")
                            .prop("files"));
            }
        ),
        $("body").on("click", ".comments *[data-comments_close]", function (e) {
            e.preventDefault(),
                e.stopImmediatePropagation(),
                $(this).closest(".comments-popup").removeClass("open"),
                $("body").css("overflow", "auto"),
                (content = null),
                (file_data = null),
                (parent_id = null);
        }),
        $("body").on("click", ".open_comment__btn", function (e) {
            e.preventDefault(),
                $(this).remove(),
                $(".open_comment").addClass("active"),
                $("#add-comment").slideToggle();
        }),
        $("body").on("click", ".comments-add__star ul li", function (e) {
            e.preventDefault();
            let t = $(this).data("star");
            $(this).closest(".comments-add").find('input[name="star"]').val(t),
                $(".comments-add__star ul li").removeClass("active");
            for (let e = 0; e <= t; e++)
                $(`.comments-add__star ul li.item-star-${e}`).addClass(
                    "active"
                );
        }),
        $("body").on(
            "click",
            ".comments *[data-comments_submit]",
            function (e) {
                e.preventDefault(),
                    e.stopImmediatePropagation(),
                    (comments = $(this).closest(".comments")),
                    (type = comments.data("type")),
                    (type_id = comments.data("type_id")),
                    (name = $(this)
                        .closest(".comments-add")
                        .find("*[name=name]")
                        .val()),
                    (phone = $(this)
                        .closest(".comments-add")
                        .find("*[name=phone]")
                        .val()),
                    (email = $(this)
                        .closest(".comments-add")
                        .find("*[name=email]")
                        .val()),
                    (content = $(this)
                        .closest(".comments-add")
                        .find("*[name=content]")
                        .val()),
                    (star = $(this)
                        .closest(".comments-add")
                        .find("*[name=star]")
                        .val());
                const t = $(this)
                        .closest(".comments-add")
                        .find("*[name=name]").length,
                    a = $(this)
                        .closest(".comments-add")
                        .find("*[name=phone]").length,
                    n = $(this)
                        .closest(".comments-add")
                        .find("*[name=email]").length,
                    o = $(this)
                        .closest(".comments-add")
                        .find("*[name=content]").length;
                (parent_id = $(this).data("comment_id")),
                    "products" != type ||
                    ("" != star && null != star && null != star) ||
                    0 != parent_id
                        ? ("" == content && o) ||
                          ("" == name && t) ||
                          ("" == phone && a) ||
                          ("" == email && n)
                            ? alertTextCmt(variable.valid_empty)
                            : a && !validatePhoneCmt(phone)
                            ? alertTextCmt(variable.valid_format_phone)
                            : n && !validateEmailCmt(email)
                            ? alertTextCmt(variable.valid_format_email)
                            : ((form_data = new FormData()),
                              form_data.append("type", type),
                              form_data.append("type_id", type_id),
                              form_data.append("content", content),
                              form_data.append("name", name),
                              form_data.append("phone", phone),
                              form_data.append("email", email),
                              form_data.append("star", star || 5),
                              form_data.append("parent_id", parent_id),
                              $(".comments .comments-add__preview .image")
                                  .length &&
                                  $(
                                      ".comments .comments-add__preview .image"
                                  ).each(function () {
                                      let e = $(this).find("input");
                                      form_data.append(
                                          "files[]",
                                          e[0].files[0]
                                      );
                                  }),
                              commendAdd(type, type_id, $(this), form_data))
                        : alertTextCmt(variable.valid_star);
            }
        );
});
